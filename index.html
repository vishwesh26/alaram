import React, { useState, useEffect, useRef } from 'react';
import { 
  Plus, 
  Trash2, 
  Zap, 
  Volume2, 
  Bomb, 
  Trophy, 
  Calculator, 
  Palette, 
  Smartphone, 
  X,
  Check,
  Edit // Added Edit icon
} from 'lucide-react';

const ComicWakeTaskApp = () => {
  // --- State (Logic from WakeTask) ---
  const [currentTime, setCurrentTime] = useState(new Date());
  
  const [alarms, setAlarms] = useState(() => {
    const saved = localStorage.getItem('comic_alarms');
    return saved ? JSON.parse(saved) : [];
  });
  
  const [streak, setStreak] = useState(() => {
    return parseInt(localStorage.getItem('comic_streak') || '0');
  });

  // Modal State
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [editingId, setEditingId] = useState(null); // Track which alarm is being edited
  const [formTime, setFormTime] = useState('');
  const [formTask, setFormTask] = useState('math');
  const [formVolume, setFormVolume] = useState(100);

  // Ringing & Task State
  const [ringingAlarm, setRingingAlarm] = useState(null);
  const [taskState, setTaskState] = useState(null); // { type, question, answer, input, ... }
  const [isShakePermitted, setIsShakePermitted] = useState(false);
  
  // Success Overlay
  const [showSuccess, setShowSuccess] = useState(false);
  const [successQuote, setSuccessQuote] = useState('');

  // Refs
  const audioCtxRef = useRef(null);
  const oscillatorRef = useRef(null);
  const beepIntervalRef = useRef(null);
  const shakeHandlerRef = useRef(null);
  const lastShakeUpdateRef = useRef(0);
  const lastShakeAccRef = useRef({ x: 0, y: 0, z: 0 });

  const QUOTES = [
    "You're a HERO today!",
    "POW! You crushed it!",
    "Unstoppable Force!",
    "Victory is YOURS!",
    "Up and at 'em, Avenger!",
    "BOOM! Morning Conquered!",
    "Kapow! Sleep Defeated!",
    "Your Origin Story Starts Now!",
    "Maximum Effort!",
    "Save the Day!"
  ];

  // --- Effects ---

  useEffect(() => {
    const timer = setInterval(() => {
      const now = new Date();
      setCurrentTime(now);

      if (now.getSeconds() === 0 && !ringingAlarm) {
        const timeStr = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false });
        const match = alarms.find(a => a.time === timeStr && a.enabled);
        if (match) triggerAlarm(match);
      }
    }, 1000);
    return () => clearInterval(timer);
  }, [alarms, ringingAlarm]);

  useEffect(() => { localStorage.setItem('comic_alarms', JSON.stringify(alarms)); }, [alarms]);
  useEffect(() => { localStorage.setItem('comic_streak', streak.toString()); }, [streak]);

  // --- Audio Logic ---
  const initAudio = () => {
    if (!audioCtxRef.current) audioCtxRef.current = new (window.AudioContext || window.webkitAudioContext)();
    if (audioCtxRef.current.state === 'suspended') audioCtxRef.current.resume();
  };

  const playAlarmSound = (volPercent) => {
    initAudio();
    const ctx = audioCtxRef.current;
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();

    osc.type = 'square'; // 'Square' wave sounds more 8-bit/retro/comic
    osc.frequency.setValueAtTime(440, ctx.currentTime);
    osc.connect(gain);
    gain.connect(ctx.destination);

    gain.gain.setValueAtTime(0.01, ctx.currentTime);
    gain.gain.linearRampToValueAtTime((volPercent / 100) * 0.5, ctx.currentTime + 0.1);

    osc.start();
    oscillatorRef.current = osc;

    // Siren effect
    let isHigh = false;
    beepIntervalRef.current = setInterval(() => {
      if (!oscillatorRef.current) return;
      const freq = isHigh ? 500 : 800; // Siren
      try { oscillatorRef.current.frequency.rampToValueAtTime(freq, ctx.currentTime + 0.1); } catch (e) { }
      isHigh = !isHigh;
    }, 400);
  };

  const stopAlarmSound = () => {
    if (oscillatorRef.current) {
      try { oscillatorRef.current.stop(); oscillatorRef.current.disconnect(); } catch (e) { }
      oscillatorRef.current = null;
    }
    if (beepIntervalRef.current) {
      clearInterval(beepIntervalRef.current);
      beepIntervalRef.current = null;
    }
    if (shakeHandlerRef.current) {
      window.removeEventListener('devicemotion', shakeHandlerRef.current);
      shakeHandlerRef.current = null;
    }
  };

  // --- Task Logic ---

  const triggerAlarm = (alarm) => {
    setRingingAlarm(alarm);
    playAlarmSound(alarm.volume || 100);

    if (alarm.taskType === 'math') setupMathTask();
    else if (alarm.taskType === 'stroop') setupStroopTask();
    else if (alarm.taskType === 'shake') setupShakeTask();
  };

  const completeTask = () => {
    stopAlarmSound();
    setRingingAlarm(null);
    setStreak(s => s + 1);
    setSuccessQuote(QUOTES[Math.floor(Math.random() * QUOTES.length)]);
    setShowSuccess(true);
  };

  // 1. Math
  const setupMathTask = () => {
    const ops = ['+', '-', 'x'];
    const op = ops[Math.floor(Math.random() * ops.length)];
    let n1 = Math.floor(Math.random() * 20) + 5;
    let n2 = Math.floor(Math.random() * 10) + 1;
    
    let ans = 0;
    if (op === '+') ans = n1 + n2;
    else if (op === '-') ans = n1 - n2;
    else if (op === 'x') { n1 = Math.floor(Math.random() * 12); ans = n1 * n2; }

    setTaskState({ type: 'math', question: `${n1} ${op} ${n2}`, answer: ans.toString(), input: '' });
  };

  const handleMathSubmit = () => {
    if (taskState.input.trim() === taskState.answer) completeTask();
    else {
      // Wrong Answer Animation logic would go here
      setTaskState(p => ({ ...p, input: '' })); 
    }
  };

  // 2. Stroop
  const setupStroopTask = () => {
    const colors = ['red', 'blue', 'green', 'yellow', 'purple', 'orange'];
    // Comic style colors
    const colorMap = {
      'red': '#ef4444', 'blue': '#3b82f6', 'green': '#22c55e',
      'yellow': '#eab308', 'purple': '#a855f7', 'orange': '#f97316'
    };

    const wordIdx = Math.floor(Math.random() * colors.length);
    let inkIdx = Math.floor(Math.random() * colors.length);
    while (inkIdx === wordIdx) inkIdx = Math.floor(Math.random() * colors.length);

    let options = [colors[inkIdx]];
    while (options.length < 4) {
      const c = colors[Math.floor(Math.random() * colors.length)];
      if (!options.includes(c)) options.push(c);
    }
    options.sort(() => Math.random() - 0.5);

    setTaskState({
      type: 'stroop',
      wordText: colors[wordIdx].toUpperCase(),
      inkColor: colors[inkIdx],
      colorMap,
      options,
      correctAnswer: colors[inkIdx]
    });
  };

  // 3. Shake
  const setupShakeTask = () => {
    setTaskState({ type: 'shake', progress: 0 });
    if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
      setIsShakePermitted(false);
    } else {
      startShakeDetection();
    }
  };

  const requestShakePerm = () => {
    DeviceMotionEvent.requestPermission().then(res => {
      if (res === 'granted') {
        setIsShakePermitted(true);
        startShakeDetection();
      }
    });
  };

  const startShakeDetection = () => {
    lastShakeUpdateRef.current = Date.now();
    lastShakeAccRef.current = { x: 0, y: 0, z: 0 };
    
    const handler = (event) => {
      const cur = event.accelerationIncludingGravity;
      if (!cur) return;
      const now = Date.now();
      if ((now - lastShakeUpdateRef.current) > 100) {
        const diff = now - lastShakeUpdateRef.current;
        lastShakeUpdateRef.current = now;
        const speed = Math.abs(cur.x + cur.y + cur.z - lastShakeAccRef.current.x - lastShakeAccRef.current.y - lastShakeAccRef.current.z) / diff * 10000;
        
        setTaskState(prev => {
          if (!prev || prev.type !== 'shake') return prev;
          let np = prev.progress + (speed > 300 ? 5 : -0.5);
          if (np < 0) np = 0;
          if (np >= 100) { np = 100; setTimeout(completeTask, 100); }
          return { ...prev, progress: np };
        });
        lastShakeAccRef.current = { x: cur.x, y: cur.y, z: cur.z };
      }
    };
    shakeHandlerRef.current = handler;
    window.addEventListener('devicemotion', handler);
  };

  // --- CRUD Logic ---

  const openModal = (id = null) => {
    if (id) {
        // Edit Mode
        const alarm = alarms.find(a => a.id === id);
        if (alarm) {
            setEditingId(id);
            setFormTime(alarm.time);
            setFormTask(alarm.taskType);
            setFormVolume(alarm.volume || 100);
            setIsModalOpen(true);
            return;
        }
    }
    // Add Mode
    setEditingId(null);
    const now = new Date(); 
    now.setMinutes(now.getMinutes() + 1);
    setFormTime(`${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`);
    setFormTask('math');
    setFormVolume(100);
    setIsModalOpen(true);
  };

  const saveAlarm = () => {
    if (!formTime) return;
    
    if (editingId) {
        // Update existing
        setAlarms(alarms.map(a => a.id === editingId ? { ...a, time: formTime, taskType: formTask, volume: parseInt(formVolume) } : a));
    } else {
        // Create new
        const newAlarm = { id: Date.now(), time: formTime, taskType: formTask, volume: parseInt(formVolume), enabled: true };
        setAlarms([...alarms, newAlarm]);
    }
    setIsModalOpen(false);
  };
  
  const toggleAlarm = (id) => setAlarms(alarms.map(a => a.id === id ? { ...a, enabled: !a.enabled } : a));
  const deleteAlarm = (id) => setAlarms(alarms.filter(a => a.id !== id));

  // --- Styles & Assets ---
  const comicBorder = "border-4 border-black shadow-[4px_4px_0px_0px_rgba(0,0,0,1)]";
  const btnStyle = `transition-all active:translate-x-[2px] active:translate-y-[2px] active:shadow-none`;

  return (
    <div className="min-h-screen bg-yellow-400 font-comic relative overflow-hidden select-none">
      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Bangers&family=Comic+Neue:wght@400;700&display=swap');
        .font-comic-display { font-family: 'Bangers', cursive; }
        .font-comic { font-family: 'Comic Neue', cursive; }
        
        .halftone {
          background-image: radial-gradient(circle, #000 2px, transparent 2.5px);
          background-size: 20px 20px;
          opacity: 0.1;
        }
        
        @keyframes pow-shake {
          0% { transform: translate(0, 0) rotate(0deg); }
          25% { transform: translate(-5px, 5px) rotate(-5deg); }
          50% { transform: translate(5px, -5px) rotate(5deg); }
          75% { transform: translate(-5px, -5px) rotate(-5deg); }
          100% { transform: translate(0, 0) rotate(0deg); }
        }
        .animate-pow { animation: pow-shake 0.5s infinite; }

        @keyframes float-speech {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .animate-float { animation: float-speech 3s ease-in-out infinite; }
      `}</style>

      <div className="absolute inset-0 halftone pointer-events-none" />

      {/* --- Main Screen --- */}
      <div className="relative z-10 flex flex-col items-center h-screen p-6 max-w-md mx-auto">
        
        {/* Header */}
        <div className="w-full flex justify-between items-center mb-8 pt-4">
            <div className={`bg-red-500 text-white px-4 py-1 -rotate-2 ${comicBorder}`}>
                <h1 className="text-2xl font-comic-display tracking-wider">BOOM! CLOCK</h1>
            </div>
            <div className="flex items-center gap-1 bg-white px-3 py-1 border-2 border-black rotate-1 font-bold">
                 <Zap size={16} className="fill-yellow-400" />
                 <span>Streak: {streak}</span>
            </div>
        </div>

        {/* Clock Bubble */}
        <div className="relative mb-12 animate-float w-full">
            <div className={`bg-white p-8 rounded-[3rem] ${comicBorder} relative z-10`}>
                <div className="text-8xl font-comic-display text-center leading-none text-black">
                    {currentTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false })}
                </div>
                <div className="text-center font-bold text-xl mt-2 bg-blue-200 inline-block px-4 border-2 border-black rotate-2 mx-auto block w-max uppercase">
                    {currentTime.toLocaleDateString([], { weekday: 'long' })}
                </div>
            </div>
            <div className="absolute -bottom-6 left-1/2 w-8 h-8 bg-white border-r-4 border-b-4 border-black transform rotate-45 z-0"></div>
        </div>

        {/* Alarm List */}
        <div className="w-full flex-1 overflow-y-auto space-y-4 pb-24 px-1">
            {alarms.length === 0 ? (
                <div className="text-center opacity-60 font-bold text-xl mt-10 rotate-2">
                    NO ALARMS... ZZZZ...
                </div>
            ) : (
                alarms.map(alarm => (
                    <div key={alarm.id} className={`relative group ${alarm.enabled ? 'bg-blue-400' : 'bg-gray-300'} p-4 ${comicBorder} flex justify-between items-center transition-all`}>
                        <div>
                            <span className="text-4xl font-comic-display text-white text-shadow-black block leading-none">
                                {alarm.time}
                            </span>
                            <div className="flex items-center gap-1 text-xs font-bold bg-black text-white px-2 py-0.5 mt-1 w-max">
                                {alarm.taskType === 'math' && <Calculator size={12} />}
                                {alarm.taskType === 'stroop' && <Palette size={12} />}
                                {alarm.taskType === 'shake' && <Smartphone size={12} />}
                                <span className="uppercase">{alarm.taskType}</span>
                            </div>
                        </div>
                        
                        <div className="flex items-center gap-3">
                            <button onClick={() => toggleAlarm(alarm.id)} className={`w-12 h-12 flex items-center justify-center border-4 border-black rounded-full transition-colors ${alarm.enabled ? 'bg-yellow-400' : 'bg-white'}`}>
                                {alarm.enabled && <Zap size={24} className="fill-black" />}
                            </button>
                            {/* Edit Button */}
                             <button onClick={() => openModal(alarm.id)} className={`bg-white p-2 border-4 border-black hover:bg-gray-100 ${btnStyle}`}>
                                <Edit size={20} />
                            </button>
                            <button onClick={() => deleteAlarm(alarm.id)} className={`bg-red-500 p-2 border-4 border-black text-white hover:bg-red-600 ${btnStyle}`}>
                                <Trash2 size={20} />
                            </button>
                        </div>
                    </div>
                ))
            )}
        </div>

        {/* FAB */}
        <button 
            onClick={() => openModal()}
            className={`absolute bottom-8 w-20 h-20 bg-green-500 rounded-full ${comicBorder} flex items-center justify-center text-white hover:scale-110 active:scale-90 transition-transform z-20`}
        >
            <Plus size={40} strokeWidth={4} />
        </button>
      </div>

      {/* --- Add/Edit Modal --- */}
      {isModalOpen && (
        <div className="absolute inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div className={`bg-white p-6 ${comicBorder} w-full max-w-sm rotate-1 shadow-[10px_10px_0px_rgba(255,255,255,0.2)]`}>
                <h2 className="text-4xl font-comic-display mb-6 text-center border-b-4 border-black pb-2">
                    {editingId ? 'EDIT MISSION' : 'NEW MISSION'}
                </h2>
                
                {/* Time Input */}
                <input 
                    type="time" 
                    value={formTime}
                    onChange={(e) => setFormTime(e.target.value)}
                    className="w-full text-center text-5xl font-comic-display border-4 border-black p-4 mb-6 bg-yellow-100 focus:bg-white outline-none"
                />

                {/* Task Select */}
                <div className="grid grid-cols-3 gap-2 mb-6">
                    {['math', 'stroop', 'shake'].map(t => (
                        <button 
                            key={t} 
                            onClick={() => setFormTask(t)}
                            className={`flex flex-col items-center justify-center p-2 border-4 border-black font-bold uppercase text-xs ${formTask === t ? 'bg-blue-400 text-white translate-x-[2px] translate-y-[2px] shadow-none' : 'bg-white shadow-[4px_4px_0px_black]'}`}
                        >
                            {t === 'math' && <Calculator size={20} />}
                            {t === 'stroop' && <Palette size={20} />}
                            {t === 'shake' && <Smartphone size={20} />}
                            {t}
                        </button>
                    ))}
                </div>

                <div className="flex gap-4">
                    <button onClick={() => setIsModalOpen(false)} className={`flex-1 bg-gray-300 font-bold py-3 border-4 border-black shadow-[4px_4px_0px_black] ${btnStyle}`}>CANCEL</button>
                    <button onClick={saveAlarm} className={`flex-1 bg-green-500 text-white font-bold py-3 border-4 border-black shadow-[4px_4px_0px_black] ${btnStyle}`}>SAVE</button>
                </div>
            </div>
        </div>
      )}

      {/* --- Ringing Overlay --- */}
      {ringingAlarm && (
        <div className="absolute inset-0 bg-red-500 z-50 flex flex-col items-center justify-center overflow-hidden">
            <div className="absolute inset-0 halftone opacity-20"></div>
            
            {/* Background Bursts */}
            <div className="absolute inset-0 flex items-center justify-center animate-[spin_10s_linear_infinite]">
                 <div className="w-[150vw] h-[150vw] bg-yellow-400 absolute rotate-12 border-y-[20px] border-black"></div>
                 <div className="w-[150vw] h-[150vw] bg-orange-500 absolute -rotate-12 border-y-[20px] border-black opacity-50"></div>
            </div>

            <div className="relative z-10 w-full max-w-md px-6 flex flex-col items-center">
                <div className="bg-white px-8 py-4 border-8 border-black shadow-[10px_10px_0px_black] -rotate-2 mb-8 animate-pow">
                    <h1 className="text-7xl font-comic-display text-red-600 leading-none">WAKE UP!</h1>
                </div>

                {/* --- Task UI --- */}
                <div className={`bg-white w-full p-6 border-4 border-black shadow-[8px_8px_0px_black] rotate-1`}>
                    
                    {/* MATH UI */}
                    {taskState?.type === 'math' && (
                        <div className="text-center">
                             <h3 className="font-bold text-xl mb-4 bg-yellow-300 inline-block px-2 border-2 border-black">SOLVE THIS:</h3>
                             <div className="text-6xl font-comic-display mb-6">{taskState.question} = ?</div>
                             <input 
                                type="number"
                                autoFocus
                                value={taskState.input}
                                onChange={(e) => setTaskState({...taskState, input: e.target.value})}
                                onKeyDown={(e) => e.key === 'Enter' && handleMathSubmit()}
                                className="w-full border-4 border-black text-4xl text-center p-2 mb-4 bg-gray-100 font-bold outline-none focus:bg-white"
                             />
                             <button onClick={handleMathSubmit} className={`w-full bg-blue-500 text-white text-2xl font-comic-display py-3 border-4 border-black shadow-[4px_4px_0px_black] ${btnStyle}`}>
                                SUBMIT!
                             </button>
                        </div>
                    )}

                    {/* STROOP UI */}
                    {taskState?.type === 'stroop' && (
                        <div className="text-center">
                            <h3 className="font-bold text-sm mb-4 bg-yellow-300 inline-block px-2 border-2 border-black uppercase">Tap INK COLOR, not word!</h3>
                            <div className="text-6xl font-comic-display mb-8" style={{ color: taskState.colorMap[taskState.inkColor], textShadow: '3px 3px 0px black' }}>
                                {taskState.wordText}
                            </div>
                            <div className="grid grid-cols-2 gap-3">
                                {taskState.options.map(color => (
                                    <button 
                                        key={color}
                                        onClick={() => {
                                            if (color === taskState.correctAnswer) completeTask();
                                            else setupStroopTask(); // Reset on fail
                                        }}
                                        className={`py-3 font-bold uppercase border-4 border-black shadow-[4px_4px_0px_black] ${btnStyle}`}
                                        style={{ backgroundColor: taskState.colorMap[color], color: 'white', textShadow: '1px 1px 0 #000' }}
                                    >
                                        {color}
                                    </button>
                                ))}
                            </div>
                        </div>
                    )}

                    {/* SHAKE UI */}
                    {taskState?.type === 'shake' && (
                        <div className="text-center">
                            <Smartphone size={80} className="mx-auto mb-4 animate-[shake_0.5s_infinite] fill-gray-200" strokeWidth={2.5} />
                            <h3 className="font-comic-display text-4xl mb-4">SHAKE IT!!</h3>
                            
                            <div className="w-full h-12 border-4 border-black bg-white relative">
                                <div 
                                    className="h-full bg-green-500 border-r-4 border-black transition-all duration-75"
                                    style={{ width: `${taskState.progress}%` }}
                                ></div>
                                {/* Striped pattern overlay for comic effect */}
                                <div className="absolute inset-0" style={{ backgroundImage: 'linear-gradient(45deg,rgba(0,0,0,0.1) 25%,transparent 25%,transparent 50%,rgba(0,0,0,0.1) 50%,rgba(0,0,0,0.1) 75%,transparent 75%,transparent)', backgroundSize: '20px 20px' }}></div>
                            </div>
                            
                            {!isShakePermitted && (
                                <button onClick={requestShakePerm} className="mt-4 underline font-bold">
                                    Tap to Enable Sensors
                                </button>
                            )}
                        </div>
                    )}
                </div>
            </div>
        </div>
      )}

      {/* --- Success Overlay --- */}
      {showSuccess && (
        <div className="absolute inset-0 bg-blue-500 z-[60] flex flex-col items-center justify-center p-6 text-center">
             <div className="absolute inset-0 bg-[radial-gradient(circle,_white_10%,_transparent_10%)] bg-[length:30px_30px] opacity-20"></div>
             
             <div className="relative z-10">
                <Trophy size={120} className="text-yellow-400 mx-auto mb-6 drop-shadow-[5px_5px_0_black]" strokeWidth={3} />
                <h1 className="text-7xl font-comic-display text-white text-shadow-black mb-2">VICTORY!</h1>
                <div className={`bg-white p-6 border-4 border-black shadow-[8px_8px_0px_black] rotate-2 max-w-xs mx-auto`}>
                    <p className="font-comic font-bold text-xl uppercase">"{successQuote}"</p>
                </div>
                
                <button 
                    onClick={() => setShowSuccess(false)}
                    className={`mt-12 bg-yellow-400 text-black text-2xl font-comic-display px-12 py-4 border-4 border-black shadow-[8px_8px_0px_black] ${btnStyle}`}
                >
                    CONTINUE
                </button>
             </div>
        </div>
      )}

    </div>
  );
};

export default ComicWakeTaskApp;
