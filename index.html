import React, { useState, useEffect, useRef } from 'react';
import { Bell, Plus, Trash2, Edit2, Brain, Calculator, X, Trophy, Volume2 } from 'lucide-react';

const WakeTaskApp = () => {
  // --- State ---
  const [currentTime, setCurrentTime] = useState(new Date());
  const [alarms, setAlarms] = useState(() => {
    const saved = localStorage.getItem('waketask_alarms');
    return saved ? JSON.parse(saved) : [];
  });
  const [streak, setStreak] = useState(() => {
    return parseInt(localStorage.getItem('waketask_streak') || '0');
  });

  // Modal State for Create/Edit
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [editingId, setEditingId] = useState(null); 
  const [formTime, setFormTime] = useState('');
  const [formTask, setFormTask] = useState('math');
  const [formVolume, setFormVolume] = useState(100); // New: Volume 0-100

  // Active Alarm State (Ringing)
  const [ringingAlarm, setRingingAlarm] = useState(null);
  const [taskQuestion, setTaskQuestion] = useState('');
  const [taskAnswer, setTaskAnswer] = useState(''); 
  const [userInput, setUserInput] = useState('');
  const [inputError, setInputError] = useState(false);

  // Success State
  const [showSuccess, setShowSuccess] = useState(false);
  const [quote, setQuote] = useState('');

  // Audio Refs
  const audioContextRef = useRef(null);
  const oscillatorRef = useRef(null);
  const gainNodeRef = useRef(null);
  const intervalRef = useRef(null);

  // Constants
  const QUOTES = [
    "Your limitation‚Äîit's only your imagination.",
    "Push yourself, because no one else is going to do it for you.",
    "Great things never come from comfort zones.",
    "Dream it. Wish it. Do it.",
    "Success doesn't just find you. You have to go out and get it."
  ];

  // --- Effects ---

  // Clock & Alarm Checker
  useEffect(() => {
    const clockInterval = setInterval(() => {
      const now = new Date();
      setCurrentTime(now);

      if (now.getSeconds() === 0 && !ringingAlarm) {
        const timeStr = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false });
        
        const match = alarms.find(a => a.time === timeStr && a.enabled);
        if (match) {
          triggerAlarm(match);
        }
      }
    }, 1000);

    return () => clearInterval(clockInterval);
  }, [alarms, ringingAlarm]);

  useEffect(() => {
    localStorage.setItem('waketask_alarms', JSON.stringify(alarms));
  }, [alarms]);

  useEffect(() => {
    localStorage.setItem('waketask_streak', streak.toString());
  }, [streak]);

  // --- Audio Logic ---
  const initAudio = () => {
    if (!audioContextRef.current) {
      audioContextRef.current = new (window.AudioContext || window.webkitAudioContext)();
    }
    if (audioContextRef.current.state === 'suspended') {
      audioContextRef.current.resume();
    }
  };

  const startAlarmSound = (volumePercent) => {
    initAudio();
    const ctx = audioContextRef.current;
    
    // Create nodes
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    
    // Convert 0-100 to 0.0-1.0 gain
    const maxGain = volumePercent / 100;

    osc.type = 'square';
    osc.frequency.setValueAtTime(440, ctx.currentTime);
    
    // Connect
    osc.connect(gain);
    gain.connect(ctx.destination);
    
    // Set initial volume
    gain.gain.setValueAtTime(0.01, ctx.currentTime);
    // Ramp up to user set volume
    gain.gain.exponentialRampToValueAtTime(Math.max(0.01, maxGain), ctx.currentTime + 0.5);

    osc.start();
    oscillatorRef.current = osc;
    gainNodeRef.current = gain;

    // Rhythmic beeping
    let isHigh = false;
    intervalRef.current = setInterval(() => {
      if (!oscillatorRef.current) return;
      const freq = isHigh ? 440 : 880; 
      oscillatorRef.current.frequency.setValueAtTime(freq, ctx.currentTime);
      isHigh = !isHigh;
    }, 500);
  };

  const stopAlarmSound = () => {
    if (oscillatorRef.current) {
      try {
        oscillatorRef.current.stop();
        oscillatorRef.current.disconnect();
      } catch (e) { console.error(e); }
      oscillatorRef.current = null;
    }
    if (intervalRef.current) {
      clearInterval(intervalRef.current);
      intervalRef.current = null;
    }
  };

  // --- Logic ---

  const triggerAlarm = (alarm) => {
    setRingingAlarm(alarm);
    
    // Generate Task
    if (alarm.taskType === 'math') {
      const operators = ['+', '-', '*'];
      const op = operators[Math.floor(Math.random() * operators.length)];
      let n1 = Math.floor(Math.random() * 20) + 5;
      let n2 = Math.floor(Math.random() * 10) + 1;
      
      if (op === '*') n1 = Math.floor(Math.random() * 12);
      
      let ans = 0;
      if (op === '+') ans = n1 + n2;
      else if (op === '-') ans = n1 - n2;
      else if (op === '*') ans = n1 * n2;
      
      setTaskQuestion(`${n1} ${op} ${n2} = ?`);
      setTaskAnswer(ans.toString());
    } else {
      // Memory
      const words = ['WAKE', 'RISE', 'SHINE', 'FAST', 'GOAL', 'CODE'];
      const w1 = words[Math.floor(Math.random() * words.length)];
      const w2 = Math.floor(Math.random() * 999);
      const target = `${w1}-${w2}`;
      
      setTaskQuestion(`Memorize: ${target}`);
      setTaskAnswer(target);
      
      setTimeout(() => {
         setTaskQuestion("Type the code:");
      }, 15000);
    }

    // Pass the saved volume to the sound function (default to 100 if missing)
    startAlarmSound(alarm.volume || 100);
  };

  const handleTaskSubmit = () => {
    if (userInput.trim().toUpperCase() === taskAnswer.toUpperCase()) {
      stopAlarmSound();
      setRingingAlarm(null);
      setUserInput('');
      setStreak(s => s + 1);
      setQuote(QUOTES[Math.floor(Math.random() * QUOTES.length)]);
      setShowSuccess(true);
    } else {
      setInputError(true);
      setUserInput('');
      setTimeout(() => setInputError(false), 500);
    }
  };

  const handleDismissSuccess = () => {
    setShowSuccess(false);
  };

  // --- CRUD Operations ---

  const openCreateModal = () => {
    setEditingId(null);
    const now = new Date();
    now.setMinutes(now.getMinutes() + 1);
    const h = String(now.getHours()).padStart(2, '0');
    const m = String(now.getMinutes()).padStart(2, '0');
    
    setFormTime(`${h}:${m}`);
    setFormTask('math');
    setFormVolume(100); // Default full volume
    setIsModalOpen(true);
  };

  const openEditModal = (alarm) => {
    setEditingId(alarm.id);
    setFormTime(alarm.time);
    setFormTask(alarm.taskType);
    setFormVolume(alarm.volume || 100);
    setIsModalOpen(true);
  };

  const saveAlarm = () => {
    if (!formTime) return;

    if (editingId) {
      // Edit
      setAlarms(prev => prev.map(a => 
        a.id === editingId 
          ? { ...a, time: formTime, taskType: formTask, volume: formVolume } 
          : a
      ));
    } else {
      // Create
      const newAlarm = {
        id: Date.now(),
        time: formTime,
        taskType: formTask,
        volume: formVolume,
        enabled: true
      };
      setAlarms(prev => [...prev, newAlarm]);
    }

    initAudio();
    setIsModalOpen(false);
  };

  const toggleAlarm = (id) => {
    setAlarms(prev => prev.map(a => 
      a.id === id ? { ...a, enabled: !a.enabled } : a
    ));
  };

  const deleteAlarm = (id) => {
    setAlarms(prev => prev.filter(a => a.id !== id));
  };

  // --- Render Helpers ---

  const formatTimeDisplay = (date) => {
    const h = String(date.getHours()).padStart(2, '0');
    const m = String(date.getMinutes()).padStart(2, '0');
    return `${h}:${m}`;
  };

  const formatDateDisplay = (date) => {
    return date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
  };

  const getFriendlyTime = (timeStr) => {
    const [h, m] = timeStr.split(':');
    const d = new Date();
    d.setHours(h);
    d.setMinutes(m);
    return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-900 via-indigo-950 to-indigo-900 text-slate-50 font-sans flex flex-col items-center overflow-hidden relative selection:bg-indigo-500/30">
      
      {/* Main Container */}
      <div className="w-full max-w-md h-screen flex flex-col relative bg-slate-900/20 backdrop-blur-sm shadow-2xl">
        
        {/* Header */}
        <header className="pt-10 pb-6 px-6 text-center">
          <div className="text-7xl font-extralight tracking-tighter bg-clip-text text-transparent bg-gradient-to-b from-white to-slate-400">
            {formatTimeDisplay(currentTime)}
          </div>
          <div className="text-slate-400 text-lg mt-[-0.5rem] font-medium">
            {formatDateDisplay(currentTime)}
          </div>
          <div className="mt-4 inline-flex items-center gap-2 px-4 py-1.5 rounded-full bg-yellow-500/10 border border-yellow-500/20 text-yellow-400 font-semibold text-sm">
            <Trophy size={14} /> Streak: {streak} days
          </div>
        </header>

        {/* Alarm List */}
        <div className="flex-1 overflow-y-auto px-4 pb-24 space-y-4 scrollbar-hide">
          {alarms.length === 0 ? (
            <div className="text-center mt-12 text-slate-500">
              <p className="text-lg">No alarms set.</p>
              <p className="text-sm opacity-70">Sleep well! üò¥</p>
            </div>
          ) : (
            alarms.sort((a,b) => a.time.localeCompare(b.time)).map(alarm => (
              <div 
                key={alarm.id} 
                className="group relative bg-slate-800/60 backdrop-blur-md border border-white/5 rounded-2xl p-5 flex items-center justify-between transition-all hover:bg-slate-800/80 active:scale-[0.98]"
              >
                <div>
                  <h2 className="text-3xl font-medium text-white tracking-tight">
                    {getFriendlyTime(alarm.time)}
                  </h2>
                  <div className="flex items-center gap-2 text-slate-400 text-sm mt-1">
                    {alarm.taskType === 'math' ? <Calculator size={14} /> : <Brain size={14} />}
                    <span className="uppercase tracking-wider text-xs font-semibold">
                      {alarm.taskType}
                    </span>
                    <span className="text-slate-600 px-1">|</span>
                    <Volume2 size={14} />
                    <span className="text-xs">{alarm.volume || 100}%</span>
                  </div>
                </div>

                <div className="flex items-center gap-4">
                  <button 
                    onClick={() => openEditModal(alarm)}
                    className="p-2 text-slate-400 hover:text-indigo-400 transition-colors bg-white/5 rounded-lg hover:bg-white/10"
                    title="Edit Alarm"
                  >
                    <Edit2 size={18} />
                  </button>

                  <label className="relative inline-flex items-center cursor-pointer">
                    <input 
                      type="checkbox" 
                      className="sr-only peer" 
                      checked={alarm.enabled}
                      onChange={() => toggleAlarm(alarm.id)}
                    />
                    <div className="w-11 h-6 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-500"></div>
                  </label>

                  <button 
                    onClick={() => deleteAlarm(alarm.id)}
                    className="text-red-400/60 hover:text-red-400 transition-colors ml-1"
                  >
                    <Trash2 size={20} />
                  </button>
                </div>
              </div>
            ))
          )}
        </div>

        {/* FAB */}
        <button 
          onClick={openCreateModal}
          className="absolute bottom-8 right-6 w-14 h-14 bg-teal-400 text-slate-900 rounded-full flex items-center justify-center shadow-[0_0_20px_rgba(45,212,191,0.4)] hover:scale-110 active:scale-95 transition-transform"
        >
          <Plus size={32} strokeWidth={2.5} />
        </button>

      </div>

      {/* --- Modals & Overlays --- */}

      {/* Create/Edit Modal */}
      {isModalOpen && (
        <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/60 backdrop-blur-sm p-4">
          <div className="w-full max-w-sm bg-slate-800 border border-white/10 rounded-3xl p-6 shadow-2xl animate-in slide-in-from-bottom-10 fade-in duration-300">
            <div className="flex justify-between items-center mb-6">
              <h3 className="text-xl font-semibold text-white">
                {editingId ? 'Edit Alarm' : 'Add Alarm'}
              </h3>
              <button onClick={() => setIsModalOpen(false)} className="text-slate-400 hover:text-white">
                <X size={24} />
              </button>
            </div>

            <div className="space-y-5">
              {/* Time Input */}
              <div>
                <label className="block text-sm text-slate-400 mb-2">Wake Up Time</label>
                <input 
                  type="time" 
                  value={formTime}
                  onChange={(e) => setFormTime(e.target.value)}
                  className="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-4 text-3xl text-center text-white focus:outline-none focus:border-indigo-500 transition-colors"
                />
              </div>

              {/* Task Selection */}
              <div>
                <label className="block text-sm text-slate-400 mb-2">Wake Up Task</label>
                <div className="grid grid-cols-2 gap-3">
                  <button 
                    onClick={() => setFormTask('math')}
                    className={`flex flex-col items-center gap-2 p-4 rounded-xl border transition-all ${
                      formTask === 'math' 
                        ? 'bg-indigo-500/20 border-indigo-500 text-indigo-300' 
                        : 'bg-slate-900 border-slate-700 text-slate-500 hover:bg-slate-800'
                    }`}
                  >
                    <Calculator size={24} />
                    <span className="text-sm font-medium">Math</span>
                  </button>
                  <button 
                    onClick={() => setFormTask('typing')}
                    className={`flex flex-col items-center gap-2 p-4 rounded-xl border transition-all ${
                      formTask === 'typing' 
                        ? 'bg-indigo-500/20 border-indigo-500 text-indigo-300' 
                        : 'bg-slate-900 border-slate-700 text-slate-500 hover:bg-slate-800'
                    }`}
                  >
                    <Brain size={24} />
                    <span className="text-sm font-medium">Memory</span>
                  </button>
                </div>
              </div>

              {/* Volume Slider */}
              <div>
                 <div className="flex justify-between text-sm text-slate-400 mb-2">
                   <label>Alarm Volume</label>
                   <span>{formVolume}%</span>
                 </div>
                 <input 
                   type="range" 
                   min="10" 
                   max="100" 
                   value={formVolume} 
                   onChange={(e) => setFormVolume(parseInt(e.target.value))}
                   className="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-indigo-500"
                 />
              </div>

              <button 
                onClick={saveAlarm}
                className="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-4 rounded-xl transition-colors mt-2"
              >
                {editingId ? 'Save Changes' : 'Set Alarm'}
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Ringing Overlay */}
      {ringingAlarm && (
        <div className="fixed inset-0 z-[100] bg-gradient-to-br from-red-500 to-red-800 flex flex-col items-center justify-center text-center p-6 animate-in fade-in duration-200">
          <div className="animate-bounce mb-6">
            <Bell size={80} className="text-white fill-white" />
          </div>
          <h1 className="text-5xl font-bold text-white mb-8 tracking-tight">WAKE UP!</h1>
          
          <div className="bg-white rounded-3xl p-8 w-full max-w-sm shadow-2xl">
            <p className="text-slate-500 text-xs font-bold tracking-widest uppercase mb-4">
              Solve to Dismiss
            </p>
            <div className="text-4xl font-bold text-slate-800 mb-6 font-mono">
              {taskQuestion}
            </div>
            
            <div className="relative">
              <input 
                type="text" 
                value={userInput}
                onChange={(e) => setUserInput(e.target.value)}
                onKeyDown={(e) => e.key === 'Enter' && handleTaskSubmit()}
                placeholder="Type answer..."
                autoComplete="off"
                className={`w-full bg-slate-100 border-2 rounded-xl px-4 py-4 text-center text-2xl font-bold text-slate-800 focus:outline-none transition-all ${
                  inputError ? 'border-red-500 bg-red-50 animate-shake' : 'border-slate-200 focus:border-indigo-500'
                }`}
              />
            </div>
            
            <button 
              onClick={handleTaskSubmit}
              className="w-full bg-indigo-600 active:bg-indigo-700 text-white font-bold py-4 rounded-xl mt-4 transition-colors text-lg"
            >
              Submit Answer
            </button>
          </div>
        </div>
      )}

      {/* Success Overlay */}
      {showSuccess && (
        <div className="fixed inset-0 z-[100] bg-gradient-to-br from-teal-500 to-emerald-700 flex flex-col items-center justify-center text-center p-8 animate-in zoom-in-95 duration-300">
          <div className="text-7xl mb-4">‚òÄÔ∏è</div>
          <h1 className="text-4xl font-bold text-white mb-2">Good Morning!</h1>
          <p className="text-emerald-100 text-lg mb-8">You're up and ready to go.</p>
          
          <div className="bg-white/10 backdrop-blur-md border border-white/20 rounded-2xl p-6 max-w-sm">
            <p className="text-xl italic font-serif text-white leading-relaxed opacity-90">
              "{quote}"
            </p>
          </div>

          <button 
            onClick={handleDismissSuccess}
            className="mt-10 bg-white text-emerald-600 hover:bg-emerald-50 px-8 py-3 rounded-full font-bold text-lg shadow-lg transition-all hover:scale-105 active:scale-95"
          >
            Start My Day
          </button>
        </div>
      )}

      <style>{`
        @keyframes shake {
          0%, 100% { transform: translateX(0); }
          25% { transform: translateX(-5px); }
          75% { transform: translateX(5px); }
        }
        .animate-shake {
          animation: shake 0.2s ease-in-out 0s 2;
        }
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
      `}</style>
    </div>
  );
};

export default WakeTaskApp;
